import os, getpass,hashlib,time
from decouple import config
from .colors import *

# Declaring Variables
api = config('vtkey')
path = os.path.dirname(__file__)
            
## querying the virus total using virustotal-search.py and api
def query_virusTotal(target_file):
    ## getting the hash code of the file of choice        
    hashcode = get_hashCode(target_file)
    username = getpass.getuser()
    ## calling the query
    query = f"python {path}/virustotal-search.py -k " + api + " -m " + hashcode
    os.system(query)

def query_virusTotal_Folder():
    username = getpass.getuser()
    for root, dirs, files in os.walk("C:/"):
        for file in files:
            try:
                hashcode = get_hashCode(file)
                query = f"python {path}/virustotal-search.py -k " + api + " -m " + hashcode
                os.system(query)
                time.sleep(5)
            except Exception as msg:
                print(colors.fg.red, f"Errorred out: {file}", colors.reset)
                time.sleep(5)
                pass

## getting the hashcode using the previous challenge
def get_hashCode(targets):
    target_file = os.path.abspath(targets)
    print(f"[+] scanning: {targets}")
    return hash_co(target_file) 

## Getting the hash code.
def hash_co(fn):
    md_hash = hashlib.md5()
    with open(fn, "rb") as f:
        for byte_block in iter(lambda: f.read(4896),b""):
            md_hash.update(byte_block)
            time.sleep(2)
    f.close()
    return md_hash.hexdigest()